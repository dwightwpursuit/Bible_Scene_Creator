<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bible Story Scene Creator</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 90%; /* Fluid width for responsiveness */
        }
        @media (min-width: 768px) {
            .container {
                max-width: 768px; /* Max width for larger screens */
            }
        }
        /* Styling for message boxes (success/error) */
        .message-box {
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            text-align: center;
        }
        .message-box.success {
            background-color: #d1fae5; /* Green for success */
            color: #065f46;
        }
        .message-box.error {
            background-color: #fee2e2; /* Red for error */
            color: #991b1b;
        }
        .message-box.info {
            background-color: #e0f2fe; /* Blue for info */
            color: #0369a1;
        }
        /* Custom style for the image placeholder text */
        .image-placeholder-text {
            color: #6b7280; /* Gray text */
            font-size: 1.125rem; /* text-lg */
            text-align: center;
        }
        /* Styles for saved items */
        .saved-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .saved-item:hover {
            background-color: #e5e7eb; /* Light gray on hover */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
    <div class="container bg-white p-8 rounded-xl shadow-lg w-full">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-6">Bible Story Scene Creator</h1>
        <p class="text-center text-gray-600 mb-8">
            Enter a Bible verse to generate a unique visual interpretation.
        </p>

        <div class="space-y-4 mb-8">
            <!-- Verse Input Fields -->
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="bookInput" placeholder="Book (e.g., John, Ps)"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="chapterInput" placeholder="Chapter (e.g., 3)"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="verseInput" placeholder="Verse(s) (e.g., 16 or 1-5)"
                       class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Style Selection Dropdown -->
            <select id="styleSelect"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                <option value="">No Specific Style</option>
                <option value="realistic photography">Realistic Photography</option>
                <option value="oil painting">Oil Painting</option>
                <option value="watercolor drawing">Watercolor Drawing</option>
                <option value="cartoon drawing">Cartoon Drawing</option>
                <option value="ancient fresco">Ancient Fresco</option>
                <option value="vibrant digital art">Vibrant Digital Art</option>
                <option value="minimalist illustration">Minimalist Illustration</option>
                <option value="pencil sketch">Pencil Sketch</option>
            </select>

            <!-- Buttons -->
            <div class="flex flex-col md:flex-row gap-4">
                <button id="lookupButton"
                        class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">
                    Look Up Verse
                </button>
                <button id="generateButton" disabled
                        class="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 ease-in-out shadow-md opacity-50 cursor-not-allowed">
                    Generate Image
                </button>
                <button id="clearButton"
                        class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 transition duration-300 ease-in-out shadow-md">
                    Clear Form
                </button>
            </div>
        </div>

        <!-- Messages and Verse Display -->
        <div id="messageArea" class="message-box hidden"></div>

        <div id="verseDisplayArea"
             class="bg-gray-100 p-4 rounded-lg text-gray-700 italic text-center mb-8 hidden">
            <!-- Retrieved verse text will appear here -->
        </div>

        <!-- Image Display Area -->
        <div id="imageContainer" class="flex flex-col justify-center items-center h-80 bg-gray-200 rounded-xl overflow-hidden shadow-inner p-4">
            <img id="generatedImage" src="" alt="Generated Bible Scene" class="max-w-full max-h-full object-contain rounded-xl hidden">
            <div id="loadingSpinner" class="hidden">
                <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <p id="imagePlaceholder" class="image-placeholder-text">Your generated scene will appear here.</p>
        </div>

        <!-- Action Buttons (Download, Save) -->
        <div class="flex flex-col md:flex-row justify-center gap-4 mt-4">
            <button id="downloadButton" disabled
                    class="flex-1 bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-300 ease-in-out shadow-md opacity-50 cursor-not-allowed">
                Download Image
            </button>
            <button id="saveButton" disabled
                    class="flex-1 bg-yellow-600 text-white p-3 rounded-lg font-semibold hover:bg-yellow-700 transition duration-300 ease-in-out shadow-md opacity-50 cursor-not-allowed">
                Save to Favorites
            </button>
        </div>

        <!-- Saved Verses Section -->
        <div class="mt-10 pt-8 border-t border-gray-300">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Saved Scenes</h2>
            <div id="savedVersesList" class="space-y-3 bg-gray-100 p-4 rounded-xl">
                <p class="text-center text-gray-500" id="noSavedVersesMessage">No scenes saved yet.</p>
                <!-- Saved scenes will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ULTIMATE DEBUGGING: This alert should pop up immediately if the script loads.
        // alert("JavaScript script loaded!"); // Removed as it was confirmed to work in Canvas
        console.log("Script execution started.");

        // --- Element References ---
        const bookInput = document.getElementById('bookInput');
        const chapterInput = document.getElementById('chapterInput');
        const verseInput = document.getElementById('verseInput');
        const styleSelect = document.getElementById('styleSelect');
        const lookupButton = document.getElementById('lookupButton');
        const generateButton = document.getElementById('generateButton');
        const clearButton = document.getElementById('clearButton');
        const downloadButton = document.getElementById('downloadButton');
        const saveButton = document.getElementById('saveButton'); // New button
        const messageArea = document.getElementById('messageArea');
        const verseDisplayArea = document.getElementById('verseDisplayArea');
        const imageContainer = document.getElementById('imageContainer');
        const generatedImage = document.getElementById('generatedImage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const savedVersesList = document.getElementById('savedVersesList'); // New list container
        const noSavedVersesMessage = document.getElementById('noSavedVersesMessage'); // New placeholder

        let currentVerseText = ""; // Stores the retrieved verse text
        let currentImageUrl = ""; // Stores the generated image URL for download
        let currentParsedRef = null; // Stores the parsed reference of the current verse
        let currentStyle = ""; // Stores the style of the current generated image

        // --- Data Storage: List of Dictionaries ---
        let savedScenes = []; // This will hold our list of dictionaries

        // --- Helper Functions for UI feedback ---
        function showMessage(type, message) {
            messageArea.classList.remove('hidden', 'success', 'error', 'info');
            messageArea.classList.add(type);
            messageArea.textContent = message;
        }

        function clearMessages() {
            messageArea.classList.add('hidden');
            messageArea.textContent = '';
        }

        function showLoading(element) {
            element.classList.remove('hidden');
        }

        function hideLoading(element) {
            element.classList.add('hidden');
        }

        // --- Data Persistence Functions (localStorage) ---
        function loadSavedScenes() {
            const storedScenes = localStorage.getItem('bibleStoryScenes');
            if (storedScenes) {
                try {
                    savedScenes = JSON.parse(storedScenes);
                    console.log("Loaded saved scenes:", savedScenes);
                } catch (e) {
                    console.error("Error parsing saved scenes from localStorage:", e);
                    savedScenes = []; // Reset if corrupted
                }
            } else {
                savedScenes = [];
            }
            renderSavedScenes(); // Always re-render after loading
        }

        function saveScenesToLocalStorage() {
            localStorage.setItem('bibleStoryScenes', JSON.stringify(savedScenes));
            console.log("Saved scenes to localStorage.");
        }

        // --- Rendering Saved Scenes List ---
        function renderSavedScenes() {
            savedVersesList.innerHTML = ''; // Clear current list
            if (savedScenes.length === 0) {
                showLoading(noSavedVersesMessage); // Show "No scenes saved yet."
            } else {
                hideLoading(noSavedVersesMessage); // Hide it
                savedScenes.forEach((scene, index) => {
                    const sceneElement = document.createElement('div');
                    sceneElement.id = `saved-scene-${scene.id}`; // Assign a unique ID
                    sceneElement.className = 'saved-item bg-white p-3 rounded-lg shadow-sm flex items-center justify-between text-gray-800';
                    sceneElement.innerHTML = `
                        <div class="flex-1 truncate">
                            <span class="font-semibold">${scene.reference}</span>
                            <span class="text-sm text-gray-600 block italic">${scene.style ? '(' + scene.style + ')' : ''}</span>
                        </div>
                        <button class="delete-btn text-red-500 hover:text-red-700 text-lg ml-4" data-id="${scene.id}">&times;</button>
                    `;
                    savedVersesList.appendChild(sceneElement);

                    // Add click listener to load scene
                    sceneElement.addEventListener('click', (event) => {
                        // Prevent loading when clicking the delete button
                        if (!event.target.classList.contains('delete-btn')) {
                            loadSceneIntoMainApp(scene);
                        }
                    });

                    // Add click listener for delete button
                    const deleteButton = sceneElement.querySelector('.delete-btn');
                    deleteButton.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent load event from firing
                        deleteScene(scene.id);
                    });
                });
            }
        }

        // --- Load Saved Scene into Main App ---
        function loadSceneIntoMainApp(scene) {
            // Clear current form and results
            clearForm(false); // Do not clear savedScenes on load

            // Populate inputs
            bookInput.value = scene.reference.split(' ')[0]; // Basic split, may need refinement for "1 John"
            const chapVerse = scene.reference.split(' ').slice(1).join(' ');
            if (chapVerse.includes(':')) {
                chapterInput.value = chapVerse.split(':')[0];
                verseInput.value = chapVerse.split(':')[1];
            } else {
                chapterInput.value = chapVerse; // Whole chapter, no verse part
                verseInput.value = '';
            }
            styleSelect.value = scene.style || '';

            currentVerseText = scene.verse_text;
            currentImageUrl = scene.image_url;
            currentParsedRef = { // Reconstruct parsedRef for potential re-generation
                book: bookInput.value.trim(),
                chapter: parseInt(chapterInput.value),
                start_verse: scene.reference.includes(':') ? parseInt(scene.reference.split(':')[1].split('-')[0]) : null,
                end_verse: scene.reference.includes(':') && scene.reference.split(':')[1].includes('-') ? parseInt(scene.reference.split(':')[1].split('-')[1]) : null
            };
            currentStyle = scene.style || '';


            verseDisplayArea.textContent = currentVerseText;
            verseDisplayArea.classList.remove('hidden');
            generatedImage.src = currentImageUrl;
            generatedImage.classList.remove('hidden');
            imageContainer.classList.remove('hidden'); // Ensure image container is shown
            hideLoading(imagePlaceholder); // Hide placeholder if image is loaded

            generateButton.disabled = false;
            generateButton.classList.remove('opacity-50', 'cursor-not-allowed');
            downloadButton.disabled = false;
            downloadButton.classList.remove('opacity-50', 'cursor-not-allowed');
            saveButton.disabled = false; // Enable save button (though it's already saved, allows re-saving if user modifies)
            saveButton.classList.remove('opacity-50', 'cursor-not-allowed');


            showMessage('info', `Loaded scene for: ${scene.reference}`);
        }

        // --- Delete Saved Scene ---
        function deleteScene(idToDelete) {
            savedScenes = savedScenes.filter(scene => scene.id !== idToDelete);
            saveScenesToLocalStorage();
            renderSavedScenes();
            showMessage('success', 'Scene deleted.');
        }


        // --- Function to Validate Bible Reference (JS Equivalent of Python's validate_bible_reference) ---
        function validateBibleReferenceJS(book, chapter, verse) {
            console.log("Validating reference:", { book, chapter, verse });
            if (!book || !chapter) {
                showMessage('error', 'Please enter at least a Book and Chapter.');
                return null;
            }

            if (isNaN(parseInt(chapter)) || parseInt(chapter) <= 0) {
                showMessage('error', 'Chapter must be a positive number.');
                return null;
            }

            let parsedVerse = null;
            let parsedEndVerse = null;

            if (verse) {
                const verseParts = verse.split('-').map(v => parseInt(v.trim()));
                if (verseParts.some(isNaN) || verseParts.some(v => v <= 0)) {
                    showMessage('error', 'Verse(s) must be positive numbers or a valid range (e.g., 16 or 1-5).');
                    return null;
                }
                parsedVerse = verseParts[0];
                if (verseParts.length > 1) {
                    parsedEndVerse = verseParts[1];
                    if (parsedEndVerse < parsedVerse) {
                        showMessage('error', 'End verse cannot be less than start verse.');
                        return null;
                    }
                }
            }
            clearMessages();
            console.log("Validation successful, parsed reference:", { book: book.trim(), chapter: parseInt(chapter), start_verse: parsedVerse, end_verse: parsedEndVerse });
            return {
                book: book.trim(),
                chapter: parseInt(chapter),
                start_verse: parsedVerse,
                end_verse: parsedEndVerse
            };
        }

        // --- Function to Get Bible Verse Text (JS Equivalent of Python's get_bible_verse_text) ---
        async function getBibleVerseTextJS(parsedReference) {
            const book = parsedReference.book;
            const chapter = parsedReference.chapter;
            const startVerse = parsedReference.start_verse;
            const endVerse = parsedReference.end_verse;

            let apiUrl = `https://bible-api.com/${book}+${chapter}`;

            if (startVerse !== null) {
                if (endVerse !== null) {
                    apiUrl += `:${startVerse}-${endVerse}`;
                } else {
                    apiUrl += `:${startVerse}`;
                }
            }
            // bible-api.com doesn't require a translation param for KJV, but if you wanted
            // a specific version for other APIs, you might add: `?translation=kjv`
            console.log("Bible API URL:", apiUrl);

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Verse not found. Please check the reference (e.g., Book Chapter:Verse).');
                    } else {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                }
                const data = await response.json();
                console.log("Bible API Response data:", data);

                if (data && data.verses && Array.isArray(data.verses)) {
                    let combinedText = data.verses.map(v => {
                        let cleanText = v.text.replace(/\s+/g, ' ').trim();
                        if (startVerse === null || (startVerse !== endVerse && endVerse !== null)) {
                            return `${v.verse_number}. ${cleanText}`;
                        }
                        return cleanText;
                    }).join(' ');

                    if (combinedText.length === 0) {
                        throw new Error('No text found for the provided reference.');
                    }
                    return combinedText;
                } else {
                    throw new Error('Unexpected API response format for Bible verse.');
                }
            } catch (error) {
                console.error('Error fetching Bible verse:', error);
                showMessage('error', `Failed to retrieve verse: ${error.message}`);
                return null;
            }
        }

        // --- Function to Generate Image Prompt (JS Equivalent of Python's generate_image_prompt) ---
        function generateImagePromptJS(verseText, style) {
            if (!verseText) {
                console.warn("generateImagePromptJS received empty verseText.");
                return "";
            }

            if (style && style.trim()) {
                return `${verseText}, in the style of a ${style.trim()}.`;
            } else {
                return verseText;
            }
        }

        // --- Function to Call AI Image Generation (JS Equivalent of Python's generate_and_display_image) ---
        async function callImagenAPI(imagePrompt) {
            clearMessages();
            hideLoading(imagePlaceholder);
            showLoading(loadingSpinner);
            imageContainer.classList.remove('hidden');
            generatedImage.classList.add('hidden');
            downloadButton.disabled = true;
            downloadButton.classList.add('opacity-50', 'cursor-not-allowed');
            saveButton.disabled = true; // Disable save button during generation
            saveButton.classList.add('opacity-50', 'cursor-not-allowed');


            const apiKey = ""; // Canvas will provide this at runtime. DO NOT change.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            const payload = {
                instances: {
                    prompt: imagePrompt
                },
                parameters: {
                    sampleCount: 1
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageBase64 = result.predictions[0]["bytesBase64Encoded"];
                    const imageUrl = `data:image/png;base64,${imageBase64}`;
                    generatedImage.src = imageUrl;
                    generatedImage.classList.remove('hidden');
                    currentImageUrl = imageUrl; // Store for download and save
                    showMessage('success', 'Image generated successfully!');
                    downloadButton.disabled = false;
                    downloadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    saveButton.disabled = false; // Enable save button after successful generation
                    saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    return imageUrl;
                } else {
                    throw new Error('Unexpected API response structure or no image generated.');
                }
            } catch (error) {
                console.error('Error generating image:', error);
                generatedImage.src = "";
                currentImageUrl = "";
                generatedImage.classList.add('hidden');
                showLoading(imagePlaceholder);
                showMessage('error', `Image generation failed: ${error.message}`);
                return null;
            } finally {
                hideLoading(loadingSpinner);
            }
        }

        // --- Save Scene Function ---
        function saveCurrentScene() {
            if (!currentVerseText || !currentImageUrl) {
                showMessage('error', 'Nothing to save. Please generate an image first.');
                return;
            }

            // Check if this exact verse and style combo is already saved
            const isAlreadySaved = savedScenes.some(scene =>
                scene.reference === `${bookInput.value.trim()} ${chapterInput.value}${verseInput.value ? ':' + verseInput.value.trim() : ''}` &&
                scene.style === styleSelect.value
            );

            if (isAlreadySaved) {
                showMessage('info', 'This scene is already saved!');
                return;
            }

            const newScene = {
                id: Date.now().toString(), // Simple unique ID for now (timestamp)
                reference: `${bookInput.value.trim()} ${chapterInput.value}${verseInput.value ? ':' + verseInput.value.trim() : ''}`,
                verse_text: currentVerseText,
                image_url: currentImageUrl,
                style: styleSelect.value,
                timestamp: new Date().toISOString(), // ISO 8601 format
                is_favorite: true // Automatically a favorite when saved
            };

            savedScenes.unshift(newScene); // Add to the beginning of the array
            saveScenesToLocalStorage();
            renderSavedScenes();
            showMessage('success', 'Scene saved to favorites!');
        }

        // --- Clear Form Function (modified to allow not clearing savedScenes) ---
        function clearForm(clearSavedToo = true) {
            bookInput.value = '';
            chapterInput.value = '';
            verseInput.value = '';
            styleSelect.value = '';
            currentVerseText = "";
            currentImageUrl = "";
            currentParsedRef = null;
            currentStyle = "";
            clearMessages();
            verseDisplayArea.classList.add('hidden');
            verseDisplayArea.textContent = '';
            generatedImage.src = "";
            generatedImage.classList.add('hidden');
            hideLoading(loadingSpinner);
            showLoading(imagePlaceholder);
            generateButton.disabled = true;
            generateButton.classList.add('opacity-50', 'cursor-not-allowed');
            downloadButton.disabled = true;
            downloadButton.classList.add('opacity-50', 'cursor-not-allowed');
            saveButton.disabled = true; // Disable save button
            saveButton.classList.add('opacity-50', 'cursor-not-allowed');
            imageContainer.classList.remove('hidden');

            if (clearSavedToo) {
                // Not actually clearing the savedScenes array here, but clearing localStorage
                // and re-rendering to reflect an empty state if desired for a full reset.
                // For a true "clear saved", you'd set savedScenes = []; and save/render.
                // Let's make this more explicit if needed for a "Clear All Saved" feature.
            }
        }

        // --- Download Image Function ---
        function downloadImage() {
            if (currentImageUrl) {
                const a = document.createElement('a');
                a.href = currentImageUrl;
                // Construct a more descriptive filename
                const filename = `bible_scene_${(bookInput.value || 'unknown').replace(/\s/g, '_')}_${chapterInput.value || 'unknown'}${verseInput.value ? '-' + verseInput.value.replace(/\s/g, '') : ''}_${(styleSelect.value || 'default').replace(/\s/g, '_')}.png`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showMessage('success', 'Image downloaded successfully!');
            } else {
                showMessage('error', 'No image to download.');
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded and parsed. Attaching event listeners.");

            // Load saved scenes from localStorage on app start
            loadSavedScenes();

            lookupButton.addEventListener('click', async () => {
                console.log("Look Up Verse button clicked!");
                clearMessages();
                verseDisplayArea.classList.add('hidden');
                generatedImage.classList.add('hidden');
                hideLoading(loadingSpinner);
                showLoading(imagePlaceholder);
                imageContainer.classList.remove('hidden');
                generateButton.disabled = true;
                generateButton.classList.add('opacity-50', 'cursor-not-allowed');
                downloadButton.disabled = true;
                downloadButton.classList.add('opacity-50', 'cursor-not-allowed');
                saveButton.disabled = true; // Disable save button on new lookup
                saveButton.classList.add('opacity-50', 'cursor-not-allowed');


                const book = bookInput.value;
                const chapter = chapterInput.value;
                const verse = verseInput.value;

                currentParsedRef = validateBibleReferenceJS(book, chapter, verse); // Store parsed ref
                console.log("Parsed Reference from validation:", currentParsedRef);

                if (currentParsedRef) {
                    showMessage('info', 'Retrieving verse text...');
                    currentVerseText = await getBibleVerseTextJS(currentParsedRef);
                    console.log("Retrieved Verse Text:", currentVerseText);
                    if (currentVerseText) {
                        verseDisplayArea.textContent = currentVerseText;
                        verseDisplayArea.classList.remove('hidden');
                        showMessage('success', 'Verse retrieved! Ready to generate image.');
                        generateButton.disabled = false;
                        generateButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        currentVerseText = "";
                        currentParsedRef = null;
                    }
                } else {
                    currentVerseText = "";
                    currentParsedRef = null;
                }
            });

            generateButton.addEventListener('click', async () => {
                if (!currentVerseText || !currentParsedRef) {
                    showMessage('error', 'Please look up a Bible verse first.');
                    return;
                }

                currentStyle = styleSelect.value; // Store current style
                const finalPrompt = generateImagePromptJS(currentVerseText, currentStyle);

                showMessage('info', 'Sending request to AI...');
                await callImagenAPI(finalPrompt);
            });

            clearButton.addEventListener('click', clearForm);
            downloadButton.addEventListener('click', downloadImage);
            saveButton.addEventListener('click', saveCurrentScene); // Attach save function

            // Initial setup on page load
            clearForm();
        });
    </script>
</body>
</html>
